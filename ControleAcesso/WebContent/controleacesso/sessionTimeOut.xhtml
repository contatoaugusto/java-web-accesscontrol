<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:h="http://java.sun.com/jsf/html"
   xmlns:ui="http://java.sun.com/jsf/facelets"
   xmlns:p="http://primefaces.org/ui">

<ui:composition>
	<script type='text/javascript' src="date.js"></script>  
	<h:form prependId="false">
      <p:idleMonitor
         timeout="#{100}"
         onidle="startIdleMonitor()" rendered="#{(request.remoteUser != null)}"/>
       #{msg['logoff.soon.1']}
       <span id="usuario" style="font-weight: bold ; font-size:12px;"> #{request.remoteUser == null ? 'visitante' : request.remoteUser} #{request.remoteUser == null ? '' : ' - Sessão expira em: '} </span>
       <span id="dialog-countdown" style="font-weight: bold ; font-size:12px;"></span>
       &nbsp;&nbsp;
       <h:outputLink value="#{facesContext.externalContext.requestContextPath}/j_spring_security_logout">
           <h:outputText value="Sair" styleClass="button"/>
       </h:outputLink>
       #{msg['logoff.soon.2']}
        
        <p style="font-weight: bold;">#{msg['move.cursor']}</p>
      	<p:dialog header="Sessão Expirada!" 
      		resizable="false"  
            widgetVar="idleDialog" 
            modal="true" 
            width="400" 
            appendToBody="true" 
            closable="false"
            draggable="false">  
		    <h:outputText value="Você será redirecionada para página de login." />  
			<p:commandButton id="continuar" value="Continuar" onclick="idleDialog.hide();redirecionaPaginaLogin()" type="button" />
		</p:dialog>
   </h:form>
   
   <script type="text/javascript">
   	  // Via de regra o tempo informado em sessio-timeout, no web.xml de configuração da aplicação é em minutos.
   	  // Normalmente 30 minutos	
      var TIME = #{session.maxInactiveInterval} ; // em segundos 
      var countTimer = TIME;
      var processTimer;
      var timer_is_on = 0;
      var redirectPage = "#{request.contextPath}/login.jsf";

      var countDownDiv = "dialog-countdown";
      var txtCountDown = null;
      if (!txtCountDown)
      	txtCountDown = document.getElementById(countDownDiv);

      function startIdleMonitor() {
          countTimer = TIME;
          txtCountDown.innerHTML = (new Date).clearTime().addSeconds(countTimer).toString('H:mm:ss');
      	  //timeoutDialog.show();
      	  doTimer();
      }
      function timedCount() {
        txtCountDown.innerHTML = (new Date).clearTime().addSeconds(countTimer).toString('H:mm:ss');
      	if (countTimer == 0) {
          	idleDialog.show();
      		stopCount();
        }
      	countTimer = countTimer - 1;
      	processTimer = setTimeout("timedCount()", 1000);
      }

	function redirecionaPaginaLogin (){
		window.location.href = redirectPage;
  		return;
	}
      
      function doTimer() {
      	if (!timer_is_on) {
      		timer_is_on = 1;
      		timedCount();
      	}
      }
      function stopCount() {
      	clearTimeout(processTimer);
      	timer_is_on = 0;
      	keepAlive();
      }
      </script>
</ui:composition>
</html>
